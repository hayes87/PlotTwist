<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Teste Final - Configura√ß√µes de Voz</title>
    <link rel="stylesheet" href="voice-styles.css">
    <link rel="stylesheet" href="voice-multiuser-styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px 4px;
            font-size: 14px;
        }
        .button:hover { background: #0056b3; }
        .button.success { background: #28a745; }
        .button.danger { background: #dc3545; }
        .setup-container {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
        }
        .log-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .test-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .test-result.pass { border-color: #28a745; background: #d4edda; }
        .test-result.fail { border-color: #dc3545; background: #f8d7da; }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .config-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .config-item strong {
            color: #495057;
        }
        .answer-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ced4da;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üéØ Teste Final - Sistema de Reconhecimento de Voz</h1>
    
    <div class="test-container">
        <h2>üìä Status do Sistema</h2>
        <div id="system-status" class="status-panel">
            Inicializando sistema...
        </div>
        
        <div class="config-grid" id="config-display">
            <!-- Configura√ß√µes ser√£o exibidas aqui -->
        </div>
        
        <div>
            <button class="button" onclick="initializeSystem()">üîÑ Reinicializar Sistema</button>
            <button class="button" onclick="runAllTests()">üß™ Executar Todos os Testes</button>
            <button class="button success" onclick="exportTestReport()">üìã Gerar Relat√≥rio</button>
        </div>
    </div>

    <div class="test-container">
        <h2>üéõÔ∏è Interface de Configura√ß√£o (Real)</h2>
        <div class="setup-container">
            <!-- Os controles reais de voz ser√£o criados aqui -->
        </div>
    </div>

    <div class="test-container">
        <h2>üé§ Simula√ß√£o de Campo de Resposta</h2>
        <input type="text" id="answer-input" class="answer-input" placeholder="Simula√ß√£o do campo de resposta do jogo">
        <div>
            <button class="button" onclick="simulateVoiceInput('resposta batman')">üé§ Simular: "resposta batman"</button>
            <button class="button" onclick="simulateVoiceInput('batman')">üé§ Simular: "batman" (sem ativa√ß√£o)</button>
            <button class="button" onclick="simulateVoiceInput('√© o superman')">üé§ Simular: "√© o superman"</button>
            <button class="button" onclick="testActivationWordsFiltering()">üîç Testar Filtros</button>
        </div>
    </div>

    <div class="test-container">
        <h2>üß™ Resultados dos Testes</h2>
        <div id="test-results">
            Nenhum teste executado ainda.
        </div>
    </div>

    <div class="test-container">
        <h2>üìù Log de Debug</h2>
        <div id="debug-log" class="log-output">
            Aguardando logs...
        </div>
        <button class="button" onclick="clearDebugLog()">üóëÔ∏è Limpar Log</button>
    </div>

    <!-- Scripts necess√°rios -->
    <script src="voice-recognition.js"></script>
    <script src="voice-recognition-multiuser.js"></script>

    <script>
        let voiceSystem = null;
        let testResults = [];
        let logCount = 0;

        // Fun√ß√µes de simula√ß√£o do ambiente do jogo
        window.submitAnswer = function() {
            addDebugLog('üéØ submitAnswer() chamado - resposta enviada!', 'success');
        };

        window.gameState = {
            isProcessingAnswer: false
        };

        window.showNotification = function(message, type, duration) {
            addDebugLog(`üì¢ NOTIFICATION [${type}]: ${message}`, 'info');
        };

        function addDebugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('debug-log');
            const colors = {
                info: '#74c0fc',
                success: '#51cf66',
                warning: '#ffd43b',
                error: '#ff6b6b',
                system: '#9775fa'
            };
            
            logCount++;
            const logEntry = `[${timestamp}] ${message}\n`;
            logArea.textContent += logEntry;
            logArea.scrollTop = logArea.scrollHeight;
            
            // Limita o log a 100 entradas
            if (logCount > 100) {
                const lines = logArea.textContent.split('\n');
                logArea.textContent = lines.slice(-50).join('\n');
                logCount = 50;
            }
        }

        // Intercepta logs do console
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            const message = args.join(' ');
            if (message.includes('üé§')) {
                addDebugLog(`CONSOLE: ${message}`, 'system');
            }
            originalLog.apply(console, args);
        };

        console.error = function(...args) {
            addDebugLog(`ERROR: ${args.join(' ')}`, 'error');
            originalError.apply(console, args);
        };

        console.warn = function(...args) {
            addDebugLog(`WARN: ${args.join(' ')}`, 'warning');
            originalWarn.apply(console, args);
        };

        function initializeSystem() {
            addDebugLog('üöÄ Inicializando sistema de reconhecimento de voz...', 'info');
            
            try {
                if (window.VoiceRecognition) {
                    voiceSystem = new VoiceRecognition();
                    window.voiceRecognition = voiceSystem;
                    addDebugLog('‚úÖ Sistema inicializado com sucesso', 'success');
                    updateSystemStatus();
                } else {
                    addDebugLog('‚ùå ERRO: Classe VoiceRecognition n√£o encontrada', 'error');
                }
            } catch (error) {
                addDebugLog(`‚ùå ERRO na inicializa√ß√£o: ${error.message}`, 'error');
            }
        }

        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            const configDiv = document.getElementById('config-display');
            
            if (voiceSystem) {
                statusDiv.className = 'status-panel success';
                statusDiv.innerHTML = `
                    <h3>‚úÖ Sistema Ativo: ${voiceSystem.constructor.name}</h3>
                    <p>Sistema inicializado e operacional</p>
                `;
                
                configDiv.innerHTML = `
                    <div class="config-item">
                        <strong>Modo Grupo:</strong><br>
                        ${voiceSystem.groupMode ? 'üü¢ ATIVO' : 'üî¥ INATIVO'}
                    </div>
                    <div class="config-item">
                        <strong>Palavras de Ativa√ß√£o:</strong><br>
                        ${voiceSystem.useActivationWord ? 'üü¢ ATIVAS' : 'üî¥ INATIVAS'}
                    </div>
                    <div class="config-item">
                        <strong>Confian√ßa M√≠nima:</strong><br>
                        ${(voiceSystem.confidenceThreshold * 100).toFixed(0)}%
                    </div>
                    <div class="config-item">
                        <strong>Auto Submit:</strong><br>
                        ${voiceSystem.autoSubmit ? 'üü¢ ATIVO' : 'üî¥ INATIVO'}
                    </div>
                    <div class="config-item">
                        <strong>Modo Cont√≠nuo:</strong><br>
                        ${voiceSystem.continuousMode ? 'üü¢ ATIVO' : 'üî¥ INATIVO'}
                    </div>
                    <div class="config-item">
                        <strong>Cooldown:</strong><br>
                        ${voiceSystem.submissionCooldown}ms
                    </div>
                `;
            } else {
                statusDiv.className = 'status-panel error';
                statusDiv.innerHTML = `
                    <h3>‚ùå Sistema N√£o Inicializado</h3>
                    <p>Clique em "Reinicializar Sistema" para tentar novamente</p>
                `;
                
                configDiv.innerHTML = `
                    <div class="config-item">
                        <strong>Status:</strong><br>
                        Sistema n√£o dispon√≠vel
                    </div>
                `;
            }
        }

        function runAllTests() {
            if (!voiceSystem) {
                addDebugLog('‚ùå Sistema n√£o inicializado para testes', 'error');
                return;
            }

            addDebugLog('üß™ === INICIANDO BATERIA DE TESTES ===', 'info');
            testResults = [];

            // Teste 1: Event Listeners
            testEventListeners();
            
            // Teste 2: Configura√ß√µes de Grupo
            setTimeout(() => testGroupModeConfiguration(), 500);
            
            // Teste 3: Palavras de Ativa√ß√£o
            setTimeout(() => testActivationWordConfiguration(), 1000);
            
            // Teste 4: Persist√™ncia
            setTimeout(() => testConfigurationPersistence(), 1500);
            
            // Teste 5: Filtros
            setTimeout(() => testFilteringLogic(), 2000);
            
            // Exibe resultados
            setTimeout(() => displayTestResults(), 2500);
        }

        function testEventListeners() {
            addDebugLog('üîç Teste 1: Event Listeners', 'info');
            
            const checkboxes = [
                { id: 'voice-group-mode', name: 'Modo Grupo' },
                { id: 'voice-activation-word', name: 'Palavras de Ativa√ß√£o' },
                { id: 'voice-enabled', name: 'Voz Habilitada' },
                { id: 'voice-auto-submit', name: 'Auto Submit' },
                { id: 'voice-continuous', name: 'Modo Cont√≠nuo' }
            ];
            
            let passCount = 0;
            
            checkboxes.forEach(item => {
                const element = document.getElementById(item.id);
                if (element) {
                    passCount++;
                    addDebugLog(`‚úÖ ${item.name}: Elemento encontrado`, 'success');
                } else {
                    addDebugLog(`‚ùå ${item.name}: Elemento N√ÉO encontrado`, 'error');
                }
            });
            
            testResults.push({
                name: 'Event Listeners',
                passed: passCount === checkboxes.length,
                details: `${passCount}/${checkboxes.length} elementos encontrados`
            });
        }

        function testGroupModeConfiguration() {
            addDebugLog('üîç Teste 2: Configura√ß√£o de Modo Grupo', 'info');
            
            const checkbox = document.getElementById('voice-group-mode');
            if (!checkbox) {
                testResults.push({
                    name: 'Configura√ß√£o Modo Grupo',
                    passed: false,
                    details: 'Checkbox n√£o encontrado'
                });
                return;
            }
            
            // Testa altern√¢ncia
            const originalState = voiceSystem.groupMode;
            voiceSystem.setGroupMode(!originalState);
            
            const newState = voiceSystem.groupMode;
            const success = newState !== originalState;
            
            addDebugLog(`Estado original: ${originalState}, Novo estado: ${newState}`, 'info');
            
            testResults.push({
                name: 'Configura√ß√£o Modo Grupo',
                passed: success,
                details: success ? 'Altern√¢ncia funcionando' : 'Altern√¢ncia falhou'
            });
            
            // Restaura estado
            voiceSystem.setGroupMode(originalState);
        }

        function testActivationWordConfiguration() {
            addDebugLog('üîç Teste 3: Configura√ß√£o de Palavras de Ativa√ß√£o', 'info');
            
            const checkbox = document.getElementById('voice-activation-word');
            if (!checkbox) {
                testResults.push({
                    name: 'Configura√ß√£o Palavras Ativa√ß√£o',
                    passed: false,
                    details: 'Checkbox n√£o encontrado'
                });
                return;
            }
            
            // Testa altern√¢ncia
            const originalState = voiceSystem.useActivationWord;
            voiceSystem.useActivationWord = !originalState;
            
            const newState = voiceSystem.useActivationWord;
            const success = newState !== originalState;
            
            addDebugLog(`Estado original: ${originalState}, Novo estado: ${newState}`, 'info');
            
            testResults.push({
                name: 'Configura√ß√£o Palavras Ativa√ß√£o',
                passed: success,
                details: success ? 'Altern√¢ncia funcionando' : 'Altern√¢ncia falhou'
            });
            
            // Restaura estado
            voiceSystem.useActivationWord = originalState;
        }

        function testConfigurationPersistence() {
            addDebugLog('üîç Teste 4: Persist√™ncia de Configura√ß√µes', 'info');
            
            // Salva configura√ß√µes de teste
            const testConfig = {
                groupMode: true,
                activationWord: true,
                confidence: 0.7
            };
            
            localStorage.setItem('voiceGroupMode', testConfig.groupMode);
            localStorage.setItem('voiceActivationWord', testConfig.activationWord);
            localStorage.setItem('voiceConfidence', testConfig.confidence);
            
            // Testa carregamento
            if (voiceSystem.loadSettings) {
                voiceSystem.loadSettings();
                
                const loaded = {
                    groupMode: voiceSystem.groupMode,
                    activationWord: voiceSystem.useActivationWord,
                    confidence: voiceSystem.confidenceThreshold
                };
                
                const success = loaded.groupMode === testConfig.groupMode && 
                               loaded.activationWord === testConfig.activationWord;
                
                testResults.push({
                    name: 'Persist√™ncia de Configura√ß√µes',
                    passed: success,
                    details: success ? 'Configura√ß√µes carregadas corretamente' : 'Falha no carregamento'
                });
                
                addDebugLog(`Configura√ß√µes carregadas: ${JSON.stringify(loaded)}`, 'info');
            } else {
                testResults.push({
                    name: 'Persist√™ncia de Configura√ß√µes',
                    passed: false,
                    details: 'M√©todo loadSettings n√£o encontrado'
                });
            }
        }

        function testFilteringLogic() {
            addDebugLog('üîç Teste 5: L√≥gica de Filtros', 'info');
            
            if (!voiceSystem.shouldProcessSpeech) {
                testResults.push({
                    name: 'L√≥gica de Filtros',
                    passed: false,
                    details: 'M√©todo shouldProcessSpeech n√£o encontrado'
                });
                return;
            }
            
            // Ativa modo grupo e palavras de ativa√ß√£o
            voiceSystem.setGroupMode(true);
            voiceSystem.useActivationWord = true;
            
            const testCases = [
                { text: 'resposta batman', expected: true, desc: 'Com palavra de ativa√ß√£o' },
                { text: 'batman', expected: false, desc: 'Sem palavra de ativa√ß√£o' },
                { text: '√© o superman', expected: true, desc: 'Com palavra de ativa√ß√£o alternativa' }
            ];
            
            let passCount = 0;
            
            testCases.forEach(testCase => {
                const result = voiceSystem.shouldProcessSpeech(testCase.text, 0.8);
                if (result === testCase.expected) {
                    passCount++;
                    addDebugLog(`‚úÖ "${testCase.text}": ${result} (${testCase.desc})`, 'success');
                } else {
                    addDebugLog(`‚ùå "${testCase.text}": ${result}, esperado ${testCase.expected} (${testCase.desc})`, 'error');
                }
            });
            
            testResults.push({
                name: 'L√≥gica de Filtros',
                passed: passCount === testCases.length,
                details: `${passCount}/${testCases.length} testes passaram`
            });
        }

        function displayTestResults() {
            addDebugLog('üìä === RESULTADOS DOS TESTES ===', 'info');
            
            const resultsDiv = document.getElementById('test-results');
            let html = '';
            let totalPassed = 0;
            
            testResults.forEach(result => {
                if (result.passed) totalPassed++;
                
                html += `
                    <div class="test-result ${result.passed ? 'pass' : 'fail'}">
                        <div>
                            <strong>${result.name}</strong><br>
                            <small>${result.details}</small>
                        </div>
                        <div>${result.passed ? '‚úÖ PASS' : '‚ùå FAIL'}</div>
                    </div>
                `;
                
                addDebugLog(`${result.passed ? '‚úÖ' : '‚ùå'} ${result.name}: ${result.details}`, 
                           result.passed ? 'success' : 'error');
            });
            
            html = `
                <h3>Resumo: ${totalPassed}/${testResults.length} testes passaram</h3>
                ${html}
            `;
            
            resultsDiv.innerHTML = html;
            
            addDebugLog(`üéØ RESUMO FINAL: ${totalPassed}/${testResults.length} testes passaram`, 
                       totalPassed === testResults.length ? 'success' : 'warning');
        }

        function simulateVoiceInput(text) {
            if (!voiceSystem) {
                addDebugLog('‚ùå Sistema n√£o inicializado', 'error');
                return;
            }
            
            addDebugLog(`üé§ Simulando entrada de voz: "${text}"`, 'info');
            
            const shouldProcess = voiceSystem.shouldProcessSpeech(text, 0.8);
            addDebugLog(`üîç Resultado do filtro: ${shouldProcess ? 'ACEITO' : 'REJEITADO'}`, 
                       shouldProcess ? 'success' : 'warning');
            
            // Atualiza campo de entrada
            const answerInput = document.getElementById('answer-input');
            if (answerInput) {
                answerInput.value = text;
                if (shouldProcess) {
                    answerInput.style.borderColor = '#28a745';
                    answerInput.style.backgroundColor = '#d4edda';
                } else {
                    answerInput.style.borderColor = '#dc3545';
                    answerInput.style.backgroundColor = '#f8d7da';
                }
                
                // Restaura cores ap√≥s 2 segundos
                setTimeout(() => {
                    answerInput.style.borderColor = '#ced4da';
                    answerInput.style.backgroundColor = 'white';
                }, 2000);
            }
        }

        function testActivationWordsFiltering() {
            addDebugLog('üîç Teste detalhado de palavras de ativa√ß√£o', 'info');
            
            if (!voiceSystem) {
                addDebugLog('‚ùå Sistema n√£o inicializado', 'error');
                return;
            }
            
            // Ativa filtros rigorosos
            voiceSystem.setGroupMode(true);
            voiceSystem.useActivationWord = true;
            
            const testPhrases = [
                'resposta batman',
                'eu sei que √© batman',
                '√© o batman',
                '√© a mulher maravilha',
                'eh o superman',
                'eh a catwoman',
                'batman',
                'superman',
                'apenas uma frase qualquer'
            ];
            
            addDebugLog(`üéØ Palavras de ativa√ß√£o dispon√≠veis: [${voiceSystem.activationWords.join(', ')}]`, 'info');
            
            testPhrases.forEach(phrase => {
                const hasActivation = voiceSystem.hasActivationWord(phrase);
                const shouldProcess = voiceSystem.shouldProcessSpeech(phrase, 0.8);
                
                addDebugLog(`"${phrase}" ‚Üí Ativa√ß√£o: ${hasActivation} | Processado: ${shouldProcess}`, 
                           shouldProcess ? 'success' : 'warning');
            });
        }

        function exportTestReport() {
            const report = {
                timestamp: new Date().toISOString(),
                system: voiceSystem ? voiceSystem.constructor.name : 'Not initialized',
                configuration: voiceSystem ? {
                    groupMode: voiceSystem.groupMode,
                    useActivationWord: voiceSystem.useActivationWord,
                    confidenceThreshold: voiceSystem.confidenceThreshold,
                    autoSubmit: voiceSystem.autoSubmit,
                    continuousMode: voiceSystem.continuousMode,
                    submissionCooldown: voiceSystem.submissionCooldown
                } : null,
                testResults: testResults,
                localStorage: {
                    voiceEnabled: localStorage.getItem('voiceEnabled'),
                    voiceGroupMode: localStorage.getItem('voiceGroupMode'),
                    voiceActivationWord: localStorage.getItem('voiceActivationWord'),
                    voiceConfidence: localStorage.getItem('voiceConfidence')
                }
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `voice-test-report-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addDebugLog('üìã Relat√≥rio de teste exportado', 'success');
        }

        function clearDebugLog() {
            document.getElementById('debug-log').textContent = '';
            logCount = 0;
            addDebugLog('üóëÔ∏è Log limpo', 'info');
        }

        // Inicializa√ß√£o autom√°tica
        document.addEventListener('DOMContentLoaded', function() {
            addDebugLog('üöÄ P√°gina carregada, inicializando...', 'info');
            setTimeout(initializeSystem, 500);
            
            // Atualiza status a cada 3 segundos
            setInterval(updateSystemStatus, 3000);
        });
    </script>
</body>
</html>
